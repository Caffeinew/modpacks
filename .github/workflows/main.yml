name: Extract files from .mrpack
permissions:
  contents: write

on:
  push:
    paths:
      - "**/*.mrpack"
  workflow_dispatch:

jobs:
  extract-mrpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed .mrpack files
        id: mrpack
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For manual trigger, find all .mrpack files
            find . -name "*.mrpack" -type f > changed_mrpack.txt
          else
            # For push trigger, find only changed files
            git diff --name-only --diff-filter=AM ${{ github.event.before }} ${{ github.sha }} | grep '.mrpack$' > changed_mrpack.txt || true
          fi
          cat changed_mrpack.txt

      - name: Extract, rename, and inject SHA-1
        run: |
          while read file; do
            # Skip if file doesn't exist (in case of deletion)
            if [ ! -f "$file" ]; then
              echo "Skipping deleted file: $file"
              continue
            fi
            
            dir=$(dirname "$file")
            name=$(basename "$file" .mrpack)
            sha1=$(sha1sum "$file" | awk '{print $1}')
            
            # Extract to the same directory as the .mrpack file
            unzip -j "$file" "modrinth.index.json" -d "$dir"
            chmod 644 "$dir/modrinth.index.json"
            jq --arg sha1 "$sha1" --arg id "$name" '. + {sha1: $sha1, id: $id}' "$dir/modrinth.index.json" > "$dir/tmp.json" && mv "$dir/tmp.json" "$dir/modrinth.index.json"

            unzip -j "$file" "overrides/icon.png" -d "$dir"

            # Rename .mrpack to instance.mrpack
            mv -f "$file" "$dir/instance.mrpack"
          done < changed_mrpack.txt

      - name: Commit extracted files
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add *.index.json *.png instance.mrpack || true
          git commit -m "Extracted and updated files from .mrpack" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
